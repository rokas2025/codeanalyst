<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Data Transfer Protocols</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, rgb(102,126,234) 0%, rgb(118,75,162) 100%);
            padding: 30px;
            color: rgb(51,51,51);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.25);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, rgb(102,126,234) 0%, rgb(118,75,162) 100%);
            color: white;
            padding: 50px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            padding: 40px;
            background: rgb(248,249,250);
        }
        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            border-left: 6px solid rgb(102,126,234);
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
        }
        .summary-card h3 {
            color: rgb(118,75,162);
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }
        .summary-card .value {
            font-size: 2.2em;
            font-weight: bold;
            color: rgb(51,51,51);
        }
        .content { padding: 40px; }
        .section { margin-bottom: 45px; }
        .section h2 {
            color: rgb(102,126,234);
            font-size: 1.9em;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid rgba(102,126,234,0.3);
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 5px 18px rgba(0,0,0,0.08);
        }
        .card h3 {
            color: rgb(102,126,234);
            margin-bottom: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 5px 18px rgba(0,0,0,0.08);
        }
        th, td {
            padding: 16px;
            text-align: left;
        }
        thead {
            background: linear-gradient(135deg, rgb(102,126,234) 0%, rgb(118,75,162) 100%);
            color: white;
        }
        tbody tr:nth-child(even) { background: rgb(248,249,250); }
        .flow-timeline {
            position: relative;
            padding-left: 40px;
        }
        .flow-step {
            margin-bottom: 25px;
            position: relative;
        }
        .flow-step:before {
            content: '';
            position: absolute;
            left: -28px;
            top: 5px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgb(118,75,162);
            box-shadow: 0 0 0 6px rgba(118,75,162,0.2);
        }
        .flow-step:after {
            content: '';
            position: absolute;
            left: -22px;
            top: 20px;
            width: 2px;
            height: calc(100% - 10px);
            background: rgba(118,75,162,0.2);
        }
        .flow-step:last-child:after { display: none; }
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .chart-wrapper {
            position: relative;
            height: 320px;
        }
        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 0.85em;
            font-weight: 600;
            color: rgb(21,87,36);
            background: rgb(212,237,218);
            margin-right: 8px;
        }
        .footer {
            background: rgb(248,249,250);
            padding: 30px;
            text-align: center;
            color: rgb(102,102,102);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Multi-Agent Data Transfer Protocols</h1>
            <p>Chatbot ⇄ Analysis Stack ⇄ Auto Code Writer</p>
            <p>Generated: 2025-11-14 15:25 (EET)</p>
        </div>

        <div class="summary">
            <div class="summary-card">
                <h3>Transport Stack</h3>
                <div class="value">HTTPS + SSE</div>
                <p>JSON payloads with optional WebSocket streaming</p>
            </div>
            <div class="summary-card">
                <h3>Auth & Trust</h3>
                <div class="value">JWT v3</div>
                <p>Service-to-service tokens signed with platform secret</p>
            </div>
            <div class="summary-card">
                <h3>LLM Providers</h3>
                <div class="value">3</div>
                <p>OpenAI · Anthropic (Claude) · Google Gemini</p>
            </div>
            <div class="summary-card">
                <h3>Protocol Version</h3>
                <div class="value">1.2</div>
                <p>Backwards-compatible schemas with schema registry</p>
            </div>
        </div>

        <div class="content">
            <div class="section">
                <h2>Reference Architecture</h2>
                <div class="grid">
                    <div class="card">
                        <h3>Pipeline Overview</h3>
                        <p>Chat UI captures intents, forwards to the orchestration API which coordinates planner, executor, and critic agents. Message bus (Redis/BullMQ) holds long-running analysis requests while auto code writer produces actionable patches with versioned diffs.</p>
                        <div class="flow-timeline">
                            <div class="flow-step">
                                <strong>01 · Intake Gateway</strong>
                                <p>Validates JWT, normalizes prompt + repo metadata, assigns <code>request_id</code>.</p>
                            </div>
                            <div class="flow-step">
                                <strong>02 · Planner Agent (Claude)</strong>
                                <p>Creates remediation plan, selects downstream providers, emits JSON plan artifact.</p>
                            </div>
                            <div class="flow-step">
                                <strong>03 · Executor Agent (GPT-4.1)</strong>
                                <p>Requests code snapshots, generates patches, submits to analysis service.</p>
                            </div>
                            <div class="flow-step">
                                <strong>04 · Critic Agent (Gemini)</strong>
                                <p>Verifies results, cross-checks tests, streams status back to chatbot.</p>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Key Guarantees</h3>
                        <ul>
                            <li>Every payload carries <code>request_id</code>, <code>protocol_version</code>, <code>trace</code>.</li>
                            <li>Streaming frames follow SSE contract: <code>event</code>, <code>id</code>, <code>data</code>.</li>
                            <li>Artifacts (plans, patches, logs) persisted in Supabase object storage.</li>
                            <li>Backpressure handled with queue depth caps and retry envelopes.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Transport Profiles</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Channel</th>
                            <th>Description</th>
                            <th>Content Type</th>
                            <th>Encryption</th>
                            <th>Streaming</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>REST (Chatbot ⇄ Orchestrator)</td>
                            <td>Primary ingress for user intents & context uploads.</td>
                            <td>application/json; charset=utf-8</td>
                            <td>TLS 1.3, JWT v3</td>
                            <td>Optional SSE for live updates</td>
                        </tr>
                        <tr>
                            <td>Message Bus (Orchestrator ⇄ Workers)</td>
                            <td>Redis Streams/BullMQ envelopes for long tasks.</td>
                            <td>JSON payload (UTF-8)</td>
                            <td>VPC private network</td>
                            <td>N/A</td>
                        </tr>
                        <tr>
                            <td>LLM Providers</td>
                            <td>OpenAI, Anthropic, Gemini via HTTPS.</td>
                            <td>JSON / text/event-stream</td>
                            <td>Provider TLS, API keys</td>
                            <td>Yes (token streaming)</td>
                        </tr>
                        <tr>
                            <td>Auto Code Writer</td>
                            <td>Webhook callback delivering patches + test logs.</td>
                            <td>application/json with diff artifacts</td>
                            <td>TLS 1.3, signed payload</td>
                            <td>Yes (WebSocket optional)</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h2>Canonical JSON Payloads</h2>
                <div class="grid">
                    <div class="card">
                        <h3>Chatbot → Orchestrator</h3>
                        <pre>{
  "protocol_version": "1.2",
  "request_id": "REQ-7c2f",
  "user": {
    "id": "user_123",
    "auth": "supabase",
    "scopes": ["repo:read", "analysis:run"]
  },
  "intent": "refactor",
  "context": {
    "repo_url": "https://github.com/org/app",
    "branch": "feature/i18n",
    "files": ["src/i18n.ts", "src/App.tsx"]
  },
  "preferences": {
    "llm_policy": "auto",
    "temperature": 0.15,
    "stream": true
  }
}</pre>
                    </div>
                    <div class="card">
                        <h3>Agent Handoff Envelope</h3>
                        <pre>{
  "request_id": "REQ-7c2f",
  "from_agent": "planner",
  "to_agent": "executor",
  "handoff_summary": "Root cause isolated to null guard.",
  "artifacts": [
    {
      "type": "plan",
      "version": "1.0",
      "steps": [
        {"id": 1, "text": "Enhance validator"},
        {"id": 2, "text": "Add regression test"}
      ]
    }
  ],
  "constraints": {
    "max_tokens": 2800,
    "style": "typescript-strict",
    "timeout_ms": 180000
  }
}</pre>
                    </div>
                    <div class="card">
                        <h3>Auto Code Writer → Chat UI</h3>
                        <pre>{
  "event": "patch_ready",
  "request_id": "REQ-7c2f",
  "diffs": [
    {
      "file": "src/validator.ts",
      "patch": "@@ -21,6 +21,10 @@"
    }
  ],
  "tests": {
    "status": "passed",
    "runtime_ms": 4120,
    "coverage_delta": +0.6
  },
  "next_actions": ["Confirm merge", "Schedule follow-up"]
}</pre>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Visual Analytics</h2>
                <div class="chart-container">
                    <h3>Latency Budget per Channel</h3>
                    <div class="chart-wrapper">
                        <canvas id="latencyChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Agent Collaboration Radar</h3>
                    <div class="chart-wrapper">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Provider Utilization Mix</h3>
                    <div class="chart-wrapper">
                        <canvas id="providerChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Operational Recommendations</h2>
                <div class="grid">
                    <div class="card">
                        <h3>Streaming & Backpressure</h3>
                        <p>Use SSE for outbound progress (analysis, patch creation). Each frame contains incremental tokens and <code>progress_pct</code>. Abort requests via <code>AbortController</code> propagated down to LLM calls.</p>
                    </div>
                    <div class="card">
                        <h3>Multi-Provider Strategy</h3>
                        <p>Planner picks model per capability tags: Claude for planning, GPT for code, Gemini for critique. Router falls back automatically if quota/responses fail, logging <code>provider_status</code>.</p>
                    </div>
                    <div class="card">
                        <h3>Observability</h3>
                        <p>Every hop emits structured logs (<code>request_id</code>, <code>agent</code>, <code>latency_ms</code>, <code>token_usage</code>). Prometheus collectors expose queue depth, provider quota, SSE clients.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>CodeAnalyst</strong> · Multi-Agent Protocol Reference</p>
            <p>Version 1.2 · Generated automatically for documentation portal</p>
        </div>
    </div>

    <script>
        const latencyCtx = document.getElementById('latencyChart').getContext('2d');
        new Chart(latencyCtx, {
            type: 'line',
            data: {
                labels: ['Ingress', 'Planning', 'Execution', 'Critique', 'Delivery'],
                datasets: [
                    {
                        label: 'Target (ms)',
                        data: [350, 900, 1100, 600, 300],
                        borderColor: 'rgba(102,126,234,1)',
                        backgroundColor: 'rgba(102,126,234,0.2)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Observed (ms)',
                        data: [320, 980, 1230, 650, 280],
                        borderColor: 'rgba(118,75,162,1)',
                        backgroundColor: 'rgba(118,75,162,0.15)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Latency (ms)' }
                    }
                }
            }
        });

        const radarCtx = document.getElementById('radarChart').getContext('2d');
        new Chart(radarCtx, {
            type: 'radar',
            data: {
                labels: ['Planning Depth', 'Code Quality', 'Hallucination Guard', 'Speed', 'Cost Efficiency'],
                datasets: [
                    {
                        label: 'Claude Planner',
                        data: [95, 70, 88, 65, 72],
                        backgroundColor: 'rgba(118,75,162,0.2)',
                        borderColor: 'rgba(118,75,162,1)',
                        pointBackgroundColor: 'rgba(118,75,162,1)'
                    },
                    {
                        label: 'GPT Executor',
                        data: [80, 96, 78, 72, 68],
                        backgroundColor: 'rgba(102,126,234,0.2)',
                        borderColor: 'rgba(102,126,234,1)',
                        pointBackgroundColor: 'rgba(102,126,234,1)'
                    },
                    {
                        label: 'Gemini Critic',
                        data: [70, 82, 94, 70, 75],
                        backgroundColor: 'rgba(45,206,229,0.2)',
                        borderColor: 'rgba(45,206,229,1)',
                        pointBackgroundColor: 'rgba(45,206,229,1)'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                    r: {
                        beginAtZero: true,
                        suggestedMax: 100
                    }
                }
            }
        });

        const providerCtx = document.getElementById('providerChart').getContext('2d');
        new Chart(providerCtx, {
            type: 'doughnut',
            data: {
                labels: ['OpenAI', 'Anthropic', 'Google Gemini'],
                datasets: [
                    {
                        data: [45, 30, 25],
                        backgroundColor: [
                            'rgba(102,126,234,0.85)',
                            'rgba(118,75,162,0.85)',
                            'rgba(45,206,229,0.85)'
                        ],
                        borderColor: 'white',
                        borderWidth: 3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed}%` } }
                }
            }
        });
    </script>
</body>
</html>
