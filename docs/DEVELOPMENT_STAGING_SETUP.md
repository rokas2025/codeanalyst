# üöÄ Development & Staging Environment Setup Guide

## Overview

This guide explains how to work with the development/staging environment without affecting the production deployment.

## Branch Strategy

```
main (production) ‚Üê‚îÄ‚îÄ DO NOT TOUCH until approved
 ‚Üë
 ‚îî‚îÄ‚îÄ develop (staging) ‚Üê‚îÄ‚îÄ Active development branch
      ‚Üë
      ‚îú‚îÄ‚îÄ feature/your-feature ‚Üê‚îÄ‚îÄ Your work here
      ‚îî‚îÄ‚îÄ feature/other-feature ‚Üê‚îÄ‚îÄ Other developer's work
```

## Current Environments

### Production (DO NOT TOUCH)
- **Branch**: `main`
- **Frontend**: `https://analyst-psi.vercel.app`
- **Backend**: `https://codeanalyst-production.up.railway.app/api`
- **Database**: Production Supabase instance

### Staging/Development (Active Development)
- **Branch**: `develop`
- **Frontend**: Will be auto-generated by Vercel (see below)
- **Backend**: To be configured in Railway (see below)
- **Database**: To be configured (see below)

---

## üé® Step 1: Vercel Frontend Setup (Automatic Preview Deployments)

### What Happens Automatically:
Vercel will **automatically create preview URLs** for the `develop` branch and any feature branches!

### Expected URLs:
- **Develop branch**: `https://analyst-psi-git-develop-[your-vercel-team].vercel.app`
- **Feature branches**: `https://analyst-psi-git-feature-name-[your-vercel-team].vercel.app`

### Setup Steps:

1. **Go to Vercel Dashboard**: https://vercel.com/dashboard
2. **Select your project**: "analyst-psi" (or your project name)
3. **Go to Settings ‚Üí Git**
4. **Ensure these settings**:
   - ‚úÖ **Production Branch**: `main`
   - ‚úÖ **Automatic Branch Deployments**: Enabled (should be on by default)
   - ‚úÖ **Preview Branches**: All branches (or specific: `develop`, `feature/*`)

5. **Set Environment Variables** (Settings ‚Üí Environment Variables):
   
   Add these with **environment-specific values**:

   | Variable Name | Production (`main`) | Preview (all other branches) |
   |---------------|-------------------|---------------------------|
   | `VITE_API_URL` | `https://codeanalyst-production.up.railway.app/api` | `https://codeanalyst-staging.up.railway.app/api` |
   | `VITE_GITHUB_CLIENT_ID` | Keep your production client ID | Create a new dev client ID (see below) |
   | `VITE_FRONTEND_URL` | `https://analyst-psi.vercel.app` | Leave empty (auto-detected) |

### Testing Vercel Setup:
```bash
# After pushing to develop branch
git push origin develop

# Check Vercel dashboard ‚Üí Deployments
# You should see a new deployment for "develop" branch
# Copy the preview URL provided
```

---

## ‚öôÔ∏è Step 2: Railway Backend Staging Setup

You need to create a **second Railway service** for staging.

### Option A: Create New Railway Service (Recommended)

1. **Go to Railway Dashboard**: https://railway.app/dashboard
2. **Select your project**
3. **Click "New Service"** (top right)
4. **Select "GitHub Repo"**
5. **Configure**:
   - **Service Name**: `codeanalyst-staging`
   - **Branch**: `develop` ‚ö†Ô∏è IMPORTANT!
   - **Root Directory**: `backend`
   - **Start Command**: `npm start`
   - **Build Command**: `npm install`

6. **Add Environment Variables** (separate from production):

   ```env
   NODE_ENV=staging
   PORT=3001
   
   # Database (create new staging database - see Step 3)
   DATABASE_URL=postgresql://[staging_db_url]
   
   # Frontend URL (will be provided by Vercel after first deploy)
   FRONTEND_URL=https://analyst-psi-git-develop-[yourteam].vercel.app
   
   # GitHub OAuth (create new staging app - see Step 4)
   GITHUB_CLIENT_ID=[staging_github_client_id]
   GITHUB_CLIENT_SECRET=[staging_github_client_secret]
   GITHUB_CALLBACK_URL=https://[staging-railway-url]/api/auth/github/callback
   
   # AI APIs (can use same keys or separate for cost tracking)
   OPENAI_API_KEY=[your_openai_key]
   ANTHROPIC_API_KEY=[your_anthropic_key]
   GOOGLE_AI_API_KEY=[your_google_key]
   
   # JWT Secret (use different secret for staging)
   JWT_SECRET=[generate_new_random_secret]
   JWT_EXPIRES_IN=7d
   ```

7. **Deploy**: Railway will automatically deploy from `develop` branch

8. **Get Railway Staging URL**: After deployment, copy the public URL (e.g., `https://codeanalyst-staging.up.railway.app`)

### Option B: Use Railway CLI (Alternative)

```bash
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Link to your project
railway link

# Create new service
railway service create codeanalyst-staging

# Deploy to staging
railway up --service codeanalyst-staging
```

---

## üóÑÔ∏è Step 3: Staging Database Setup

### Option 1: Create New Supabase Project (Recommended - FREE)

1. **Go to Supabase**: https://supabase.com/dashboard
2. **Create New Project**: `codeanalyst-staging`
3. **Region**: Choose same as production for consistency
4. **Get Connection String**:
   - Go to Settings ‚Üí Database
   - Copy "Connection string" (URI format)
   
5. **Run Database Migrations**:
   ```bash
   # Connect to staging database
   psql "postgresql://postgres:[password]@[staging-host]:5432/postgres"
   
   # Run your schema
   \i database-schema.sql
   ```

6. **Update Railway Staging Service**:
   - Go to Railway ‚Üí codeanalyst-staging ‚Üí Variables
   - Update `DATABASE_URL` with new Supabase staging URL

### Option 2: Use Same Database, Different Schema (Not Recommended)

```sql
-- Create staging schema
CREATE SCHEMA staging;

-- Duplicate tables in staging schema
-- (You'd need to modify your backend code to use schema prefix)
```

---

## üîê Step 4: GitHub OAuth Staging App

Create a **separate GitHub OAuth App** for staging:

1. **Go to GitHub**: Settings ‚Üí Developer settings ‚Üí OAuth Apps
2. **New OAuth App**:
   - **Application name**: `CodeAnalyst Staging`
   - **Homepage URL**: `https://analyst-psi-git-develop-[yourteam].vercel.app`
   - **Authorization callback URL**: `https://codeanalyst-staging.up.railway.app/api/auth/github/callback`
   
3. **Generate Client Secret**

4. **Copy Client ID and Secret**

5. **Update Railway Staging Variables**:
   ```
   GITHUB_CLIENT_ID=[staging_client_id]
   GITHUB_CLIENT_SECRET=[staging_client_secret]
   ```

6. **Update Vercel Preview Environment Variables**:
   ```
   VITE_GITHUB_CLIENT_ID=[staging_client_id]
   ```

---

## üë• Daily Development Workflow

### Starting New Feature:

```bash
# 1. Switch to develop and pull latest
git checkout develop
git pull origin develop

# 2. Create feature branch
git checkout -b feature/my-new-feature

# 3. Make your changes
# ... edit files ...

# 4. Commit and push
git add .
git commit -m "feat: add my new feature"
git push origin feature/my-new-feature
```

### Vercel Automatically Creates Preview URL!
- Check Vercel dashboard or GitHub PR comments for the preview URL
- Test your feature at: `https://analyst-psi-git-feature-my-new-feature-[team].vercel.app`

### Creating Pull Request:

```bash
# 1. Go to GitHub
# 2. Create Pull Request: feature/my-new-feature ‚Üí develop
# 3. Request review from team member
# 4. After approval, merge to develop
# 5. Delete feature branch
```

### Staging Deployment:
- **Automatic**: When you merge to `develop`, Vercel and Railway auto-deploy
- **Staging URLs update automatically**
- **Test thoroughly** before merging to `main`

### Production Deployment (Only when approved):
```bash
# 1. Create PR: develop ‚Üí main
# 2. Get approval from project owner
# 3. Merge to main
# 4. Production automatically updates
```

---

## üîç Testing Your Setup

### 1. Test Vercel Preview:
```bash
# Push to develop
git push origin develop

# Wait 2-3 minutes
# Check Vercel dashboard for deployment status
# Visit preview URL
```

### 2. Test Railway Staging:
```bash
# Check Railway dashboard for deployment logs
# Test API health: https://codeanalyst-staging.up.railway.app/api/health

# Expected response:
{
  "success": true,
  "status": "healthy",
  "timestamp": "...",
  "services": {
    "database": "connected",
    "redis": "connected"
  }
}
```

### 3. Test End-to-End:
1. Open Vercel preview URL
2. Try to login with GitHub (staging OAuth app)
3. Try to analyze a website
4. Try to analyze a GitHub repo
5. Verify everything works without affecting production

---

## üìã Quick Reference

### Git Commands:
```bash
# See current branch
git branch

# Switch to develop
git checkout develop

# Pull latest changes
git pull origin develop

# Create feature branch
git checkout -b feature/name

# See what branch a file is in
git log --all --source -- path/to/file
```

### URLs After Setup:

| Environment | Frontend | Backend | Branch |
|-------------|----------|---------|--------|
| **Production** | `analyst-psi.vercel.app` | `codeanalyst-production.up.railway.app` | `main` |
| **Staging** | `analyst-psi-git-develop-*.vercel.app` | `codeanalyst-staging.up.railway.app` | `develop` |
| **Your Feature** | `analyst-psi-git-feature-name-*.vercel.app` | Uses staging backend | `feature/*` |

---

## ‚ö†Ô∏è Important Rules

1. **DO NOT** push directly to `main` branch
2. **DO NOT** merge to `main` without approval
3. **ALWAYS** create feature branches from `develop`
4. **ALWAYS** merge feature branches to `develop` first
5. **TEST** thoroughly in staging before merging to `main`
6. **USE** meaningful commit messages: `feat:`, `fix:`, `docs:`, `chore:`

---

## üÜò Troubleshooting

### Vercel preview not deploying?
- Check Vercel dashboard ‚Üí Settings ‚Üí Git
- Ensure "Automatic Branch Deployments" is enabled
- Check if build succeeded in deployments tab

### Railway staging not working?
- Check Railway logs for errors
- Verify environment variables are set correctly
- Ensure `develop` branch is set in service settings

### GitHub OAuth not working in staging?
- Verify callback URL matches exactly
- Check GITHUB_CLIENT_ID in both Vercel and Railway
- Ensure Vercel preview URL is correct in GitHub OAuth app settings

### Database connection error?
- Verify DATABASE_URL is correct
- Check if staging database is running
- Test connection with psql

---

## üìû Need Help?

Check Railway logs:
```bash
railway logs --service codeanalyst-staging
```

Check Vercel logs:
```bash
vercel logs [deployment-url]
```

---

**Last Updated**: $(date)
**Version**: 1.0.0
**Environment**: Development & Staging

