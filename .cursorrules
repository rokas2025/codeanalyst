# Cursor AI Rules for CodeAnalyst Project (Root – Frontend + Global)

## 0. Platform / Environment (Windows + PowerShell)

- **OS**: Windows 10/11
- **Shell**: PowerShell (not bash)
- **Path separators**: Prefer backslashes `\` and relative paths like `.\backend`, `.\scripts\...`
- **Line endings**: CRLF (Windows style)

### Terminal Commands

- Always use **PowerShell-compatible** syntax.
- Do **NOT** use bash operators or tools:
  - ❌ `&&`, `grep`, `sed`, `awk`, `curl | sh`, etc.
- Use either:
  - Separate lines, or
  - `;` to chain commands in PowerShell.

Examples:

- ✅ `cd backend; npm install; npm run dev`
- ✅ `Get-ChildItem -Recurse src | Select-String "TODO"`
- ❌ `cd backend && npm install && npm run dev`
- ❌ `grep -R "TODO" src`

When generating scripts:
- Prefer `.ps1` scripts for PowerShell.
- Don’t assume a bash shell.

---

## 1. Project Overview & Structure

- **Frontend**: React 18 + TypeScript (strict) + Vite, Tailwind CSS, Zustand.
- **Backend**: Node.js 22.x + Express (ES modules, `"type": "module"`) in `/backend`.
- **Database**: PostgreSQL (Supabase).
- **Cache / Jobs**: Redis + Bull.
- **Auth**: Hybrid system (custom GitHub OAuth + Supabase Auth).
- **WordPress plugin**: `/wordpress-plugin` for WP integration.

Root-level structure (simplified):

- `/src/**` – Frontend (React, TS).
- `/backend/**` – Backend API (Express, Node).
- `/wordpress-plugin/**` – WordPress connector plugin.
- `/docs/**` – Documentation.
- `/scripts/**` – Migration & deployment scripts.

When working from root:
- Assume the main concern is **frontend** unless I explicitly say “backend” or “WordPress plugin”.

---

## 2. Environment Variables & Secrets

### Backend (Railway) – examples

- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY` (secret, admin only)
- `DATABASE_URL`
- `GITHUB_CLIENT_ID`, `GITHUB_CLIENT_SECRET`
- `JWT_SECRET`
- `OPENAI_API_KEY`, `GOOGLE_AI_API_KEY`, other provider keys

### Frontend (Vercel) – examples

- `VITE_SUPABASE_URL`
- `VITE_SUPABASE_ANON_KEY` (public, client-side)
- `VITE_API_URL`
- `VITE_GITHUB_CLIENT_ID`
- `VITE_FRONTEND_URL`

**Rules:**

- Treat all `*_SECRET`, `*_API_KEY`, `SUPABASE_SERVICE_ROLE_KEY` as **secrets**.
- **Never** expose or hardcode real values in code snippets or docs.
- Frontend:
  - Use only `VITE_*` vars (e.g. `VITE_SUPABASE_ANON_KEY`).
  - **Never** use `SUPABASE_SERVICE_ROLE_KEY` on the client.
- Backend:
  - Keep secrets only in server config / env.
  - When editing env docs, use placeholders:
    - `JWT_SECRET=<your-secret-here>`

---

## 3. Authentication System (Hybrid – handle with care)

- **GitHub OAuth**: Custom implementation (keep backward compatible).
- **Email/Password + Google OAuth**: via Supabase Auth.
- Users are synced to PostgreSQL `users` table.
- JWT tokens used for sessions (30 days).

**Critical files (do NOT modify unless I explicitly allow):**

- `/backend/src/middleware/auth.js` – Hybrid auth logic.
- `/backend/src/routes/auth.js` – Auth routes.

You may **read** these files to understand behavior, but:

- Prefer fixes in:
  - Frontend flows (`src/pages`, `src/pages/modules`, `src/services`).
  - Callers / non-auth routes in backend.
  - Logging / error reporting around auth (using logger).

If a change in these files is truly required:
- Explain **why** and propose the **smallest possible diff**.
- Wait for my explicit approval.

---

## 4. Code Style & Logging

- Frontend:
  - TypeScript strict mode enabled (`"strict": true`).
  - Use React function components + hooks.
  - Tailwind CSS is the styling system.
  - Path alias: `@/*` → `./src/*`.
- Backend:
  - ES modules only (`import`/`export`), no `require()` or `module.exports`.
  - Node 22.x, Express 4.
  - Use the existing **logger** (e.g. Winston), **not `console.log`**.

When editing backend code:
- Replace or avoid `console.log` with the existing logger.

---

## 5. Frontend – Files & Directory Priorities

High priority when working on frontend features or bugs:

- `src/pages/modules/**` – Main app modules (CodeAnalyst, WebsiteAnalyst, ContentCreator, etc.).
- `src/components/**` – Reusable UI components.
- `src/services/**` – API clients and business logic.
- `src/stores/**` – Zustand state management.
- `src/utils/**` and `src/types/**` – Shared helpers & types.

When I describe a frontend feature/bug:

1. Start from the relevant **page/module** under `src/pages/modules/**`.
2. Then look at the **service** in `src/services/**` used by that module.
3. Only then touch shared `components/`, `stores/`, `utils/` if clearly required.

Do **not** open or edit other modules or docs “for context” unless I request it.

---

## 6. Other folders from root perspective

- `/backend/**` – Treat as **separate backend subsystem**.
  - Only open when I explicitly say we’re working on backend or a specific API issue.
- `/wordpress-plugin/**` – Treat as **separate WordPress subsystem**.
  - Only open when I mention WordPress or the plugin.
- `/docs/**` – Documentation, usually not needed for coding tasks.
- Build / dependencies:
  - `dist/`, `build/`, `node_modules/` – do not open.

---

## 7. Credit Optimization – What NOT to open by default

To save tokens/credits, **avoid reading/opening** these unless I explicitly ask:

- `/docs/**` – any markdown docs.
- Any file matching:
  - `*_SUMMARY.md`
  - `*_COMPLETE.md`
  - `*_GUIDE.md`
- `/wordpress-plugin/**` – only for WP-specific tasks.
- `/backend/**` – unless backend/API work is explicitly requested.
- Build / dependency folders:
  - `node_modules/`
  - `dist/`
  - `build/`
- Large result/analysis JSON:
  - `*_result_*.json`
  - `website_analysis_*.json`

When I ask a question:
- Work in the **smallest relevant subset** of files instead of scanning the entire repo.

---

## 8. Testing – Frontend

Frontend tests:

- Framework: **Vitest + React Testing Library (jsdom)**.
- Commands:
  - `npm run test`
  - `npm run test:coverage`

Rules:

- Reuse existing test patterns and structure.
- Don’t scan the entire `src/` just to “learn how tests work”.
- Keep tests focused on the component/module being changed.

---

## 9. High-Credit Operations – Ask First

Before performing expensive operations that likely open many files or use a lot of context:

- “Audit entire repo”
- “Explain all modules”
- “Update error handling everywhere”
- “Refactor all services”
- Large search/replace across many folders

You must:

1. Explain your intended **scope and plan** briefly.
2. Ask me to **confirm** or narrow the scope.
3. Prefer a **smaller** initial batch (e.g. one module, one folder).

---

## 10. Multi-file Edits

When using multi-file edits (Composer):

1. Keep the changed file list as **small as possible**.
2. After applying changes, provide a **summary**:
   - Which files were changed.
   - Short description of what changed in each file.
3. If more than ~10 files are needed, propose:
   - “Batch 1: X, Y, Z files”
   - “Batch 2: …”
   - and ask me which batch to apply first.

---

## 11. Deployment & CLI Tools (for reference)

- **Frontend**: Vercel (auto-deploy from `main`).
- **Backend**: Railway (auto-deploy from `main`).
- **Database**: Supabase PostgreSQL.

CLI tools commonly used (on Windows / PowerShell):

- `railway` – Railway CLI (e.g. `railway variables --set "KEY=value"`).
- `vercel` – Vercel CLI (e.g. `echo "value" | vercel env add KEY production`).
- `git` – Version control.
- `npm` – Package manager.

When suggesting CLI usage:
- Assume these tools may be installed.
- Use **PowerShell-friendly** commands only.

---

## 12. Testing & Deployment Strategy

### Testing Policy
- **DO NOT test local server builds** unless explicitly requested by user
- **ALWAYS test on deployed environments:**
  - Frontend: Vercel (production environment)
  - Backend: Railway (production environment)
- Local testing is only for quick syntax/linting checks
- Full integration testing happens post-deployment

### Deployment Architecture
- **Frontend**: Vercel
  - Auto-deploys from `main` branch
  - Env vars managed via Vercel dashboard
  
- **Backend**: Railway
  - Auto-deploys from `main` branch
  - Env vars managed via Railway dashboard

### Workflow
1. Make code changes
2. Lint/verify syntax locally (if needed)
3. Commit and push to GitHub
4. Wait for auto-deployment (Vercel + Railway)
5. Test on deployed URLs
6. Check Railway logs if backend issues
7. Check Vercel logs if frontend issues

### Why This Approach?
- Avoids "works on my machine" issues
- Environment parity (local ≠ production)
- Railway/Vercel handle dependencies, not local Node
- Saves time (no local server startup debugging)
- Credits saved (no testing failed local builds)

### Exception - When to Test Locally
Only start local servers if:
- User explicitly requests local testing
- Debugging Railway/Vercel-specific deployment issues
- Testing new npm packages before committing
- Quick development iteration (user-initiated)

---

## 13. WordPress Plugin Integration Rules

### Backend ES Modules (CRITICAL)

When editing files in `backend/src/services/**`:

- **NEVER** use `require()` – this is an ES modules project
- Always use ES module imports
- Check existing imports at top of file before adding new ones

```javascript
// ❌ WRONG - CommonJS in ES module
const file = require('fs').createWriteStream(destination)
require('fs').unlink(destination, () => {})

// ✅ CORRECT - ES module imports
import { createWriteStream, unlink } from 'fs'
const file = createWriteStream(destination)
unlink(destination, () => {})
```

### WordPress Plugin Changes

When editing files in `wordpress-plugin/**`:

1. **Always bump version number** when making changes:
   - Header in `codeanalyst-connector.php`: `* Version: X.Y.Z`
   - Constant: `define('CODEANALYST_VERSION', 'X.Y.Z')`

2. **Update CHANGELOG.md** with changes

3. **Test with both parent themes and child themes**

4. Use `error_log()` for debugging, check `wp-content/debug.log`

### ZIP File Creation for WordPress Plugin

When creating/updating the plugin ZIP:

- Root folder inside ZIP **must be** `codeanalyst-connector/`
- **Always use forward slashes** (`/`) not backslashes (`\`)
- Include all subdirectories (`admin/`, `includes/`)

```powershell
# Correct approach using .NET
Add-Type -AssemblyName System.IO.Compression.FileSystem
[System.IO.Compression.ZipFile]::CreateFromDirectory(
    $sourceFolder,
    $zipPath,
    [System.IO.Compression.CompressionLevel]::Optimal,
    $true  # Include base directory name
)
```

### AI Response Parsing Pattern

When working with `AIAnalysisService.js`:

- `callAI()` returns `{response, providerUsed, model, tokensUsed, responseTime}`
- **Always extract `.response`** before JSON.parse()

```javascript
const aiResult = await this.callAI(prompt, type, options)
const responseText = aiResult.response || aiResult  // Handle both cases
return this.parseInsights(responseText, data)
```

### WordPress Child Theme File Paths

When working with WordPress REST API:

- Child theme files from parent are prefixed with `[parent]/`
- Example: `[parent]/functions.php` comes from template directory

```php
// Plugin must detect prefix and use correct directory
if (strpos($file, '[parent]/') === 0) {
    $file = str_replace('[parent]/', '', $file);
    $base_dir = get_template_directory();  // Parent theme
} else {
    $base_dir = get_stylesheet_directory(); // Child theme
}
```

### Plugin Version Update Checklist

When updating plugin version:

1. `wordpress-plugin/codeanalyst-connector.php` - bump version (header + constant)
2. `wordpress-plugin/CHANGELOG.md` - add entry
3. `src/pages/ConnectedSites.tsx` - update version check string
4. `backend/src/routes/wordpress.js` - update X-Plugin-Version header
5. Rebuild ZIP with correct structure
6. Test plugin installation creates correct folder name

### Reference Documentation

See `docs/WORDPRESS_INTEGRATION.md` for:
- Full architecture overview
- Common issues and solutions
- Debugging tips
- REST API endpoint reference

